type: vertical-stack
cards:
  - type: custom:button-card
    icon: mdi:robot-vacuum-variant
    entity: sensor.REPLACE_WITH_ENTITY_ID_robot_error
    size: 50%
    color_type: icon
    tap_action:
      action: none
    hold_action:
      action: none
    double_tap_action:
      action: none
    name: |
      [[[
        const uiState = states['sensor.REPLACE_WITH_ENTITY_ID_ui_state']?.state;
        if (uiState.includes('STATE_IDLE')) return "IDLE";
        else if (uiState.includes('STATE_STANDBY')) return "STANDBY";
        else if (uiState.includes('STATE_HOUSECLEANINGPAUSED')) return "House Cleaning Paused";
        else if (uiState.includes('STATE_HOUSECLEANINGRUNNING')) return "Cleaning House";
        else if (uiState.includes('STATE_STARTHOUSECLEANING')) return "Starting House Cleaning";
        else return uiState
      ]]]
    styles:
      icon:
        - color: |
            [[[
                if (!entity.state.startsWith('200')) return "#950606";
                else if (!states["sensor.REPLACE_WITH_ENTITY_ID_robot_alert"]?.state?.startsWith('200')) return "#edb926";
            ]]]
      card:
        - border-radius: 20px
        - display: flex
        - justify-content: center
        - align-items: center
        - margin: 0 auto
        - position: relative
      custom_fields:
        battery:
          - position: absolute
          - top: 8px
          - right: 8px
          - padding: 4px 8px
          - border-radius: 8px
          - font-weight: bold
          - animation: |
              [[[ 
                return states['binary_sensor.REPLACE_WITH_ENTITY_ID_charging_active']?.state === "on" ? 'pulseGreen 3s infinite' : ''
              ]]]
          - background-color: |
              [[[
                console.log(variables)
                if (Number(states["sensor.REPLACE_WITH_ENTITY_ID_fuel_percent"]?.state) > 35) return 'green';
                else return '#FFBF00'
              ]]]
        dock:
          - position: absolute
          - top: 8px
          - left: 8px
          - padding: 4px
          - border-radius: 8px
          - background-color: rgba(255,255,255,0.2)
          - display: |
              [[[
                return states['binary_sensor.REPLACE_WITH_ENTITY_ID_ext_power_present']?.state === "on"
                  ? "block"
                  : "none";
              ]]]
    custom_fields:
      battery: >-
        [[[ return states["sensor.REPLACE_WITH_ENTITY_ID_fuel_percent"]?.state + '%'
        ]]]
      dock: |
        [[[
          // Show an icon if docked
          if (states['binary_sensor.REPLACE_WITH_ENTITY_ID_ext_power_present']?.state === 'on') {
            return 'DOCKED';
          } else {
            return 'sdfsdf';
          }
        ]]]
    extra_styles: |
      @keyframes pulseGreen {
          0% {
            box-shadow: 0 0 5px 0 rgba(0,255,0,0.6);
          }
          50% {
            box-shadow: 0 0 20px 6px rgba(0,255,0,1);
          }
          100% {
            box-shadow: 0 0 5px 0 rgba(0,255,0,0.6);
          }
      }
  - type: vertical-stack
    cards:
      - type: horizontal-stack
        cards:
          - type: custom:button-card
            show_icon: false
            entity: sensor.REPLACE_WITH_ENTITY_ID_robot_alert
            show_state: false
            styles:
              card:
                - border-color: |
                    [[[
                      if (entity.state.startsWith('200')) return ""
                      else return "#edb926"
                    ]]]
            name: |
              [[[
                if (entity.state.startsWith('200')) return "No alerts";
                // If it does not match this regex perfectly, then return as it is
                try { return entity.state.match(/\(UI_(ERROR|ALERT)_(.+)\)/)[2].replaceAll('_', ' ') }
                catch { return entity.state }
              ]]]
          - type: custom:button-card
            show_icon: false
            entity: sensor.REPLACE_WITH_ENTITY_ID_robot_error
            show_state: false
            styles:
              card:
                - border-color: |
                    [[[
                      if (entity.state.startsWith('200')) return ""
                      else return "#950606"
                    ]]]
            name: |
              [[[
                if (entity.state.startsWith('200')) return "No errors";
                // If it does not match this regex perfectly, then return as it is
                try { return entity.state.match(/\(UI_(ERROR|ALERT)_(.+)\)/)[2].replaceAll('_', ' ') }
                catch { return entity.state }
              ]]]
  - type: horizontal-stack
    cards:
      - type: custom:button-card
        entity: button.REPLACE_WITH_ENTITY_ID_house_clean
        name: Clean
        tap_action:
          action: toggle
      - type: custom:button-card
        entity: button.REPLACE_WITH_ENTITY_ID_spot_clean
        name: Clean
        tap_action:
          action: toggle
      - type: custom:button-card
        entity: button.REPLACE_WITH_ENTITY_ID_stop_cleaning
        name: STOP
        tap_action:
          action: toggle
      - type: custom:button-card
        entity: button.REPLACE_WITH_ENTITY_ID_locate_robot
        name: Locate
        tap_action:
          action: toggle
      - type: custom:button-card
        name: Settings
        icon: mdi:cog
        tap_action:
          action: fire-dom-event
          browser_mod:
            service: browser_mod.popup
            data:
              title: More options
              size: normal
              content:
                type: vertical-stack
                cards:
                  - type: horizontal-stack
                    cards:
                      - show_name: true
                        show_icon: true
                        entity: switch.REPLACE_WITH_ENTITY_ID_eco_mode
                        name: ECO Mode
                        type: button
                      - show_name: true
                        show_icon: true
                        entity: switch.REPLACE_WITH_ENTITY_ID_test_mode
                        name: Test Mode
                        type: button
                      - entity: button.REPLACE_WITH_ENTITY_ID_update_status
                        name: Fetch status
                        show_icon: true
                        type: button
                        tap_action:
                          action: toggle
                      - entity: binary_sensor.REPLACE_WITH_ENTITY_ID_usb_connected
                        name: USB
                        show_icon: true
                        type: button
                  - type: entities
                    entities:
                      - entity: switch.REPLACE_WITH_ENTITY_ID_intenseclean
                        name: Intense Clean
                      - entity: switch.REPLACE_WITH_ENTITY_ID_led
                        name: LED
                      - entity: switch.REPLACE_WITH_ENTITY_ID_wifi
                        name: WiFi
                      - entity: switch.REPLACE_WITH_ENTITY_ID_melody_sounds
                        name: Melody Sounds
                      - entity: switch.REPLACE_WITH_ENTITY_ID_warning_sounds
                        name: Warning Sounds
                      - entity: switch.REPLACE_WITH_ENTITY_ID_click_sounds
                        name: Click Sounds
                      - entity: switch.REPLACE_WITH_ENTITY_ID_bin_full_detect
                        name: Bin Full Detect
                      - entity: switch.REPLACE_WITH_ENTITY_ID_schedule
                        name: Schedule
                    state_color: false
                    show_header_toggle: false
                  - type: entities
                    entities:
                      - entity: sensor.REPLACE_WITH_ENTITY_ID_model
                        name: Model
                      - entity: sensor.REPLACE_WITH_ENTITY_ID_serial_number
                        name: S/N
                      - entity: sensor.REPLACE_WITH_ENTITY_ID_time_local
                        name: Robot Time
                      - entity: sensor.REPLACE_WITH_ENTITY_ID_battery_voltage_v
                        name: Battery Voltage
                      - entity: sensor.REPLACE_WITH_ENTITY_ID_battery_temp_c_avg
                        name: Battery Temp (avg)
                      - entity: sensor.REPLACE_WITH_ENTITY_ID_charger_mah
                        name: Charging
                      - entity: sensor.REPLACE_WITH_ENTITY_ID_discharge_mah
                        name: Discharging
                  - type: horizontal-stack
                    cards:
                      - show_name: true
                        show_icon: true
                        entity: button.REPLACE_WITH_ENTITY_ID_shutdown
                        type: button
                        name: Power Off
                        tap_action:
                          action: toggle
                      - show_name: true
                        show_icon: true
                        entity: button.REPLACE_WITH_ENTITY_ID_powercycle
                        name: Reboot Robot
                        type: button
                        tap_action:
                          action: toggle
                      - show_name: true
                        show_icon: true
                        type: button
                        entity: button.REPLACE_WITH_ENTITY_ID_reboot_esp
                        name: Reboot ESP
                        tap_action:
                          action: toggle
